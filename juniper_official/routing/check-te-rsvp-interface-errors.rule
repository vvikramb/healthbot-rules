/*
 * Detects rsvp-te interface errors and notifies anomalies.
 */
healthbot {
    topic routing.mpls {
        rule check-te-rsvp-interface-errors {
            keys te-interface;
            synopsis "RSVP TE interface statistics analyzer";
            description "Collects RSVP TE interface error statistics periodically and notifies when error count increases";
            sensor lsp {
                open-config {
                    sensor-name /network-instances/network-instance/mpls/signaling-protocols/rsvp-te/interface-attributes/interface;
                    frequency 60s;
                }
            }
            field authentication-fail {
                sensor lsp {
                    path /network-instances/network-instance/mpls/signaling-protocols/rsvp-te/interface-attributes/interface/state/error-counters/authentication-fail;
                    zero-suppression;
                    data-if-missing {
                        value 0;
                    }
                }
                type integer;
                description "Authentication fail error count";
            }
            field bad-checksum {
                sensor lsp {
                    path /network-instances/network-instance/mpls/signaling-protocols/rsvp-te/interface-attributes/interface/state/error-counters/bad-checksum;
                    zero-suppression;
                    data-if-missing {
                        value 0;
                    }
                }
                type integer;
                description "Bad checksum error count";
            }
            field bad-packet-format {
                sensor lsp {
                    path /network-instances/network-instance/mpls/signaling-protocols/rsvp-te/interface-attributes/interface/state/error-counters/bad-packet-format;
                    zero-suppression;
                    data-if-missing {
                        value 0;
                    }
                }
                type integer;
                description "Bad packet format error count";
            }
            field bad-packet-length {
                sensor lsp {
                    path /network-instances/network-instance/mpls/signaling-protocols/rsvp-te/interface-attributes/interface/state/error-counters/bad-packet-length;
                    zero-suppression;
                    data-if-missing {
                        value 0;
                    }
                }
                type integer;
                description "Bad packet length error count";
            }
            field bad-packet-version {
                sensor lsp {
                    path /network-instances/network-instance/mpls/signaling-protocols/rsvp-te/interface-attributes/interface/state/error-counters/bad-packet-version;
                    zero-suppression;
                    data-if-missing {
                        value 0;
                    }
                }
                type integer;
                description "Bad packet version error count";
            }
            field in-path-error-messages {
                sensor lsp {
                    path /network-instances/network-instance/mpls/signaling-protocols/rsvp-te/interface-attributes/interface/state/counters/in-path-error-messages;
                    zero-suppression;
                    data-if-missing {
                        value 0;
                    }
                }
                type integer;
                description "In path messages error count";
            }
            field in-reservation-error-messages {
                sensor lsp {
                    path /network-instances/network-instance/mpls/signaling-protocols/rsvp-te/interface-attributes/interface/state/counters/in-reservation-error-messages;
                    zero-suppression;
                    data-if-missing {
                        value 0;
                    }
                }
                type integer;
                description "In reservation messages error count";
            }
            field message-out-of-order {
                sensor lsp {
                    path /network-instances/network-instance/mpls/signaling-protocols/rsvp-te/interface-attributes/interface/state/error-counters/message-out-of-order;
                    zero-suppression;
                    data-if-missing {
                        value 0;
                    }
                }
                type integer;
                description "Out of order messages error count";
            }
            field out-path-error-messages {
                sensor lsp {
                    path /network-instances/network-instance/mpls/signaling-protocols/rsvp-te/interface-attributes/interface/state/counters/out-path-error-messages;
                    zero-suppression;
                    data-if-missing {
                        value 0;
                    }
                }
                type integer;
                description "Out of path error count";
            }
            field out-reservation-error-messages {
                sensor lsp {
                    path /network-instances/network-instance/mpls/signaling-protocols/rsvp-te/interface-attributes/interface/state/counters/out-reservation-error-messages;
                    zero-suppression;
                    data-if-missing {
                        value 0;
                    }
                }
                type integer;
                description "Out reservation error count";
            }
            field received-nack {
                sensor lsp {
                    path /network-instances/network-instance/mpls/signaling-protocols/rsvp-te/interface-attributes/interface/state/error-counters/received-nack;
                    zero-suppression;
                    data-if-missing {
                        value 0;
                    }
                }
                type integer;
                description "Received no acknowledgement error count";
            }
            field recv-pkt-disabled-intf {
                sensor lsp {
                    path /network-instances/network-instance/mpls/signaling-protocols/rsvp-te/interface-attributes/interface/state/error-counters/recv-pkt-disabled-intf;
                    zero-suppression;
                    data-if-missing {
                        value 0;
                    }
                }
                type integer;
                description "Received packet disable error count";
            }
            field send-failure {
                sensor lsp {
                    path /network-instances/network-instance/mpls/signaling-protocols/rsvp-te/interface-attributes/interface/state/error-counters/send-failure;
                    zero-suppression;
                    data-if-missing {
                        value 0;
                    }
                }
                type integer;
                description "Send failure error count";
            }
            field state-timeout {
                sensor lsp {
                    path /network-instances/network-instance/mpls/signaling-protocols/rsvp-te/interface-attributes/interface/state/error-counters/state-timeout;
                    zero-suppression;
                    data-if-missing {
                        value 0;
                    }
                }
                type integer;
                description "State timeout error count";
            }
            field te-interface {
                sensor lsp {
                    where "/network-instances/network-instance/mpls/signaling-protocols/rsvp-te/interface-attributes/interface/@interface-id =~ /{{input-te-interface}}/";
                    path "/network-instances/network-instance/mpls/signaling-protocols/rsvp-te/interface-attributes/interface/@interface-id";
                }
                type string;
                description "RSVP interface to be monitored";
            }
            field unknown-ack {
                sensor lsp {
                    path /network-instances/network-instance/mpls/signaling-protocols/rsvp-te/interface-attributes/interface/state/error-counters/unknown-ack;
                    zero-suppression;
                    data-if-missing {
                        value 0;
                    }
                }
                type integer;
                description "Unknown acknowledgement error count";
            }
            field unknown-nack {
                sensor lsp {
                    path /network-instances/network-instance/mpls/signaling-protocols/rsvp-te/interface-attributes/interface/state/error-counters/unknown-nack;
                    zero-suppression;
                    data-if-missing {
                        value 0;
                    }
                }
                type integer;
                description "Unknown no acknowledgement error count";
            }
            /*
             * Anomaly detection logic to detect rsvp-te interface errors.
             */
            trigger rsvp-te-interface-authentication-fail-errors {
                alert-type routing.mpls.rsvp.errors.rsvp-te-interface-authentication-fail-errors;			
                frequency 1offset;
                term is-authentication-fail {
                    when {
                        increasing-at-least-by-value "$authentication-fail" {
                            value 1;
                            time-range 2.5offset;
                            latest;
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Authentication failure error count($authentication-fail)increasing on $te-interface";
                        }
                        next;
                    }
                }					
                term no-authentication-fail {
                    when {
                        exists "$authentication-fail";
                    }				
                    then {
                        status {
                            color green;
                            message "Authentication failure error count($authentication-fail)on $te-interface is normal";
                        }
                    }
                }
            }					
            trigger rsvp-te-interface-bad-checksum-errors {
                alert-type routing.mpls.rsvp.errors.rsvp-te-interface-bad-checksum-errors;			
                frequency 1offset;			
                term is-bad-checksum {
                    when {
                        increasing-at-least-by-value "$bad-checksum" {
                            value 1;
                            time-range 2.5offset;
                            latest;
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Bad checksum error count($bad-checksum)increasing on $te-interface";
                        }
                        next;
                    }
                }
                term no-bad-checksum {
                    when {
                        exists "$bad-checksum";
                    }				
                    then {
                        status {
                            color green;
                            message "Bad checksum error count($bad-checksum)on $te-interface is normal";
                        }
                    }
                }				
            }
            trigger rsvp-te-interface-bad-packet-format-errors {
                alert-type routing.mpls.rsvp.errors.rsvp-te-interface-bad-packet-format-errors;			
                frequency 1offset;			
                term is-bad-packet-format {
                    when {
                        increasing-at-least-by-value "$bad-packet-format" {
                            value 1;
                            time-range 2.5offset;
                            latest;
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Bad packet format error count($bad-packet-format)increasing on $te-interface";
                        }
                        next;
                    }
                }
                term no-bad-packet-format {
                    when {
                        exists "$bad-packet-format";
                    }				
                    then {
                        status {
                            color green;
                            message "Bad packet format error count($bad-packet-format)increasing on $te-interface is normal";
                        }
                    }
                }				
            }
            trigger rsvp-te-interface-bad-packet-length-errors {
                alert-type routing.mpls.rsvp.errors.rsvp-te-interface-bad-packet-length-errors;			
                frequency 1offset;			
                term is-bad-packet-length {
                    when {
                        increasing-at-least-by-value "$bad-packet-length" {
                            value 1;
                            time-range 2.5offset;
                            latest;
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Bad packet length error count($bad-packet-length)increasing on $te-interface";
                        }
                        next;
                    }
                }
                term no-bad-packet-length {
                    when {
                        exists "$bad-packet-length";
                    }				
                    then {
                        status {
                            color green;
                            message "Bad packet length error count($bad-packet-length)on $te-interface is normal";
                        }
                    }
                }				
            }
            trigger rsvp-te-interface-bad-packet-version-errors {
                alert-type routing.mpls.rsvp.errors.rsvp-te-interface-bad-packet-version-errors;			
                frequency 1offset;			
                term is-bad-packet-version {
                    when {
                        increasing-at-least-by-value "$bad-packet-version" {
                            value 1;
                            time-range 2.5offset;
                            latest;
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Bad packet version error count($bad-packet-version)increasing on$te-interface";
                        }
                        next;
                    }
                }
                term no-bad-packet-version {
                    when {
                        exists "$bad-packet-version";
                    }				
                    then {
                        status {
                            color green;
                            message "Bad packet version error count($bad-packet-version)on $te-interface is normal";
                        }
                    }
                }				
            }
            trigger rsvp-te-interface-in-path-error-messages-errors {
                alert-type routing.mpls.rsvp.errors.rsvp-te-interface-in-path-error-messages-errors;			
                frequency 1offset;			
                term is-in-path-error-messages {
                    when {
                        increasing-at-least-by-value "$in-path-error-messages" {
                            value 1;
                            time-range 2.5offset;
                            latest;
                        }
                    }
                    then {
                        status {
                            color red;
                            message "In path error messages count($in-path-error-messages)increasing on $te-interface";
                        }
                        next;
                    }
                }
                term no-in-path-error-messages {
                    when {
                        exists "$in-path-error-messages";
                    }				
                    then {
                        status {
                            color green;
                            message "In path error messages count($in-path-error-messages)on $te-interface is normal";
                        }
                    }
                }				
            }
            trigger rsvp-te-interface-in-reservation-error-messages-errors {
                alert-type routing.mpls.rsvp.errors.rsvp-te-interface-in-reservation-error-messages-errors;			
                frequency 1offset;			
                term in-reservation-error-messages {
                    when {
                        increasing-at-least-by-value "$in-reservation-error-messages" {
                            value 1;
                            time-range 2.5offset;
                            latest;
                        }
                    }
                    then {
                        status {
                            color red;
                            message "In reservation error messages count($in-reservation-error-messages)increasing on $te-interface";
                        }
                        next;
                    }
                }
                term no-in-reservation-error-messages {
                    when {
                        exists "$in-reservation-error-messages";
                    }				
                    then {
                        status {
                            color green;
                            message "In reservation error messages count($in-reservation-error-messages)on $te-interface";
                        }
                    }
                }				
            }
            trigger rsvp-te-interface-message-out-of-order-errors {
                alert-type routing.mpls.rsvp.errors.rsvp-te-interface-message-out-of-order-errors;			
                frequency 1offset;			
                term is-message-out-of-order {
                    when {
                        increasing-at-least-by-value "$message-out-of-order" {
                            value 1;
                            time-range 2.5offset;
                            latest;
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Message out of order error count($message-out-of-order)increasing on $te-interface";
                        }
                        next;
                    }
                }
                term no-message-out-of-order {
                    when {
                        exists "$message-out-of-order";
                    }				
                    then {
                        status {
                            color green;
                            message "Message out of order error count($message-out-of-order)on $te-interface is normal";
                        }
                    }
                }				
            }
            trigger rsvp-te-interface-out-path-error-messages-errors {
                alert-type routing.mpls.rsvp.errors.rsvp-te-interface-out-path-error-messages-errors;			
                frequency 1offset;			
                term out-path-error-messages {
                    when {
                        increasing-at-least-by-value "$out-path-error-messages" {
                            value 1;
                            time-range 2.5offset;
                            latest;
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Out path error messages count($out-path-error-messages)increasing on $te-interface";
                        }
                        next;
                    }
                }
                term no-out-path-error-messages {
                    when {
                        exists "$out-path-error-messages";
                    }				
                    then {
                        status {
                            color green;
                            message "Out path error messages count($out-path-error-messages)on $te-interface is normal";
                        }
                    }
                }				
            }
            trigger rsvp-te-interface-out-reservation-error-messages-errors {
                alert-type routing.mpls.rsvp.errors.rsvp-te-interface-out-reservation-error-messages-errors;			
                frequency 1offset;			
                term out-reservation-error-messages {
                    when {
                        increasing-at-least-by-value "$out-reservation-error-messages" {
                            value 1;
                            time-range 2.5offset;
                            latest;
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Out reservation error messages count($out-reservation-error-messages)increasing on $te-interface";
                        }
                        next;
                    }
                }
                term no-out-reservation-error-messages {
                    when {
                        exists "$out-reservation-error-messages";
                    }				
                    then {
                        status {
                            color green;
                            message "Out reservation error messages count($out-reservation-error-messages) on $te-interface is normal";
                        }
                    }
                }				
            }
            trigger rsvp-te-interface-received-nack-errors {
                alert-type routing.mpls.rsvp.errors.rsvp-te-interface-received-nack-errors;			
                frequency 1offset;			
                term is-received-nack {
                    when {
                        increasing-at-least-by-value "$received-nack" {
                            value 1;
                            time-range 2.5offset;
                            latest;
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Received nack error count($received-nack)increasing on $te-interface";
                        }
                        next;
                    }
                }
                term no-received-nack {
                    when {
                        exists "$received-nack";
                    }				
                    then {
                        status {
                            color green;
                            message "Received nack error count($received-nack) on $te-interface is normal";
                        }
                    }
                }				
            }
            trigger rsvp-te-interface-recv-pkt-disabled-intf-errors {
                alert-type routing.mpls.rsvp.errors.rsvp-te-interface-recv-pkt-disabled-intf-errors;			
                frequency 1offset;			
                term recv-pkt-disabled-intf {
                    when {
                        increasing-at-least-by-value "$recv-pkt-disabled-intf" {
                            value 1;
                            time-range 2.5offset;
                            latest;
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Recv-pkt-disabled-intf error count($recv-pkt-disabled-intf)increasing on $te-interface";
                        }
                        next;
                    }
                }
                term no-recv-pkt-disabled-intf {
                    when {
                        exists "$recv-pkt-disabled-intf";
                    }				
                    then {
                        status {
                            color green;
                            message "Recv-pkt-disabled-intf error count($recv-pkt-disabled-intf) on $te-interface is normal";
                        }
                    }
                }				
            }
            trigger rsvp-te-interface-send-failure-errors {
                alert-type routing.mpls.rsvp.errors.rsvp-te-interface-send-failure-errors;			
                frequency 1offset;			
                term send-failure {
                    when {
                        increasing-at-least-by-value "$send-failure" {
                            value 1;
                            time-range 2.5offset;
                            latest;
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Send failure error count($send-failure)increasing on $te-interface";
                        }
                        next;
                    }
                }
                term no-send-failure {
                    when {
                        exists "$send-failure";
                    }				
                    then {
                        status {
                            color green;
                            message "Send failure error count($send-failure) on $te-interface is normal";
                        }
                    }
                }				
            }
            trigger rsvp-te-interface-state-timeout-errors {
                alert-type routing.mpls.rsvp.errors.rsvp-te-interface-state-timeout-errors;			
                frequency 1offset;			
                term is-state-timeout {
                    when {
                        increasing-at-least-by-value "$state-timeout" {
                            value 1;
                            time-range 2.5offset;
                            latest;
                        }
                    }
                    then {
                        status {
                            color red;
                            message "State timeout error count($state-timeout)increasing on $te-interface";
                        }
                    }
                }
                term no-state-timeout {
                    when {
                        exists "$state-timeout";
                    }				
                    then {
                        status {
                            color green;
                            message "State timeout error count($state-timeout) on $te-interface is normal";
                        }
                    }
                }				
            }
            variable input-te-interface {
                value .*;
                description "Interface names to monitor, regular expression, eg 'ge-.*'";
                type string;
            }
            rule-properties {
                version 1;
                contributor juniper;
                category advanced;
                is-scaling-rule {
                    description "Fields:te-interface ; Directly impacted by number of te-interfaces running in each network device";
                }
                supported-healthbot-version 2.1.0;
                supported-devices {
                    juniper {
                        operating-system junos {
                            products MX {
                                platforms MX204 {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }								
                                platforms MX240 {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }
                                platforms MX304 {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }								
                                platforms MX480 {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }
                                platforms MX960 {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }
                                platforms MX10004 {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }
                                platforms MX10008 {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }
                                platforms MX10016 {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }								
                            }
                            products JNP {
                                platforms JNP10004 {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }
                                platforms JNP10008 {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }
                                platforms JNP10016 {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }								
                            }							
                        }
                        operating-system junosEvolved {
                            products ACX {
                                platforms ACX7024 {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }
                                platforms ACX7100-32C {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }
                                platforms ACX7100-48L {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }								
                                platforms ACX7348 {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }
                                platforms ACX7332 {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }								
                                platforms ACX7024X {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }
                                platforms ACX7509 {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }
                            }
                            products PTX {
                                platforms PTX10001-36MR-K {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }
                                platforms PTX10001-36MR {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }
                                platforms PTX10001-20C {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }
                                platforms PTX10004 {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }
                                platforms PTX10008 {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }
                                platforms PTX10016 {
                                    releases 20.1R1 {
                                        release-support min-supported-release;
                                    }
                                }								
                            }							
                        }						
                    }
                }
            }
        }
    }
}